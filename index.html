<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Ngaji v3.1</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script type="module" src="app.js"></script>
</head>
<body>

    <div class="navbar">
        <div class="menu-icon" onclick="toggleSidebar()">â˜°</div>
        <div style="font-weight:bold">E-Absensi</div>
        <button class="btn-small hidden" id="btn-to-peserta" onclick="logout()">Log Peserta</button>
    </div>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <h3>Menu</h3>
        <button onclick="document.getElementById('modal-tambah').classList.remove('hidden'); toggleSidebar();">Tambah Akun</button>
        <button style="background:#2980b9" onclick="loginAdmin()">Masuk Admin</button>
    </div>

    <div class="container">
        <div id="modal-tambah" class="card hidden">
            <h3>Registrasi Nama</h3>
            <input id="p-nama" placeholder="Nama Lengkap">
            <input id="p-kelompok" placeholder="Kelompok">
            <input id="p-desa" placeholder="Desa">
            <button onclick="saveProfile()">Simpan</button>
            <button style="background:#ccc" onclick="document.getElementById('modal-tambah').classList.add('hidden')">Batal</button>
        </div>

        <div id="pilih-akun-section" class="card hidden">
            <h2>Pilih Nama</h2>
            <div id="list-akun-pilihan"></div>
        </div>

        <div id="peserta-section" class="card hidden">
            <h2 id="display-nama"></h2>
            <div id="reader"></div>
            <button onclick="startScanner()" style="margin-top:20px">SCAN SEKARANG</button>
            <div id="scan-result"></div>
            <p onclick="logout()" style="color:#888; cursor:pointer; font-size:12px">Ganti Akun</p>
        </div>

        <div id="admin-section" class="card hidden">
            <h2>Panel Admin</h2>
            <div class="card" style="box-shadow:none; border:1px solid #eee; padding:15px">
                <input id="ev-nama" placeholder="Contoh: Pengajian Selasa Wage">
                <input id="ev-tgl" type="date">
                <button onclick="createNewEvent()">SET EVENT & QR</button>
            </div>

            <div id="qr-area" class="hidden">
                <div style="margin-bottom:20px">
                    <p><b>QR HADIR</b> (Klik Perbesar)</p>
                    <canvas id="canvas-absen" onclick="showFullQR('canvas-absen', 'QR HADIR')"></canvas>
                </div>
                <div>
                    <p><b>QR IZIN</b> (Klik Perbesar)</p>
                    <canvas id="canvas-izin" onclick="showFullQR('canvas-izin', 'QR IZIN')"></canvas>
                </div>
                <button style="background:#e74c3c; margin-top:30px" onclick="closeEvent()">NONAKTIFKAN QR</button>
            </div>

            <button style="background:#f39c12" onclick="downloadExcel()">REKAP EXCEL</button>
            <ul id="report-list" style="text-align:left; padding:0"></ul>
        </div>
    </div>

    <div id="full-qr-modal" class="fullscreen-qr hidden">
        <h2 id="full-title">QR Code</h2>
        <canvas id="full-canvas"></canvas>
        <button class="btn-download" onclick="downloadQR()">ðŸ’¾ SIMPAN KE HP (PNG)</button>
        <button style="background:#333" onclick="document.getElementById('full-qr-modal').classList.add('hidden')">KEMBALI</button>
    </div>

    <script>
        window.addEventListener('load', () => {
            const role = sessionStorage.getItem('role');
            const akun = localStorage.getItem('akun_aktif');
            const daftar = JSON.parse(localStorage.getItem('daftar_akun')) || [];

            if(role === 'admin') {
                document.getElementById('admin-section').classList.remove('hidden');
                document.getElementById('btn-to-peserta').classList.remove('hidden');
                if(window.loadReports) window.loadReports();
            } else if(akun) {
                document.getElementById('peserta-section').classList.remove('hidden');
                document.getElementById('display-nama').innerText = JSON.parse(akun).nama;
            } else if(daftar.length > 0) {
                document.getElementById('pilih-akun-section').classList.remove('hidden');
                const cont = document.getElementById('list-akun-pilihan');
                daftar.forEach(a => {
                    cont.innerHTML += `<div class="account-box">
                        <span onclick="pilihAkun(${a.id})" style="flex:1; cursor:pointer; font-weight:bold">${a.nama}</span>
                        <button onclick="hapusAkun(${a.id})" style="width:35px; background:#e74c3c">X</button>
                    </div>`;
                });
            } else {
                document.getElementById('modal-tambah').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
