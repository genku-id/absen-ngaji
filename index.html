<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Ngaji</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script type="module" src="app.js"></script>
</head>
<body>

    <div class="navbar">
        <div class="menu-icon" onclick="toggleSidebar()">â˜°</div>
        <div style="font-weight:bold; font-size: 18px;">Absensi Ngaji</div>
    </div>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <h3 style="margin-top: 0; color: #27ae60;">Menu</h3>
        <button class="btn-outline" onclick="document.getElementById('modal-tambah').classList.remove('hidden'); toggleSidebar();">âž• Tambah Akun</button>
        
        <div id="logout-sidebar-btn" class="hidden">
            <button class="btn-danger-outline" onclick="logout()">ðŸšª Ganti / Keluar Akun</button>
        </div>

        <button class="btn-admin" onclick="loginAdmin()">ðŸ”‘ Panel Admin</button>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <p style="font-size:11px; color: #a0aec0; text-align: center;">Aplikasi Absensi v2.1</p>
    </div>

    <div class="container">
        <div id="pilih-akun-section" class="card hidden">
            <h2 style="margin-top:0">Pilih Akun</h2>
            <div id="list-akun-pilihan"></div>
        </div>

        <div id="modal-tambah" class="card hidden">
            <h2 style="margin-top:0">Tambah Akun</h2>
            <input type="text" id="p-nama" placeholder="Nama Lengkap">
            <input type="text" id="p-kelompok" placeholder="Kelompok">
            <input type="text" id="p-desa" placeholder="Desa">
            <button onclick="saveProfile()">Simpan Profil</button>
            <button style="background:#94a3b8" onclick="document.getElementById('modal-tambah').classList.add('hidden')">Batal</button>
        </div>

        <div id="peserta-section" class="card hidden">
            <p style="color: #718096; margin-bottom: 5px;">Selamat Datang,</p>
            <h2 style="margin-top:0; color: #2d3748;" id="display-nama"></h2>
            
            <div id="reader"></div>
            
            <button id="btn-scan-trigger" onclick="startScanner()" style="margin-top:20px">ðŸ“· Mulai Scan Barcode</button>
            
            <div id="scan-result" style="margin-top:15px; font-weight:bold; color:#27ae60"></div>
        </div>

        <div id="admin-section" class="card hidden">
            <h2 style="margin-top:0">Panel Admin</h2>
            <button onclick="createNewEvent()">Buat Event Baru</button>
            <button style="background:#f39c12" onclick="downloadExcel()">ðŸ“Š Download Rekap</button>
            <button style="background:#e74c3c" onclick="logout()">Keluar Admin</button>
            
            <div id="qr-area" class="hidden">
                <p>QR Code Kehadiran:</p>
                <canvas id="canvas-absen"></canvas>
                <button style="background:#c0392b; margin-top:10px" onclick="closeEvent()">Tutup Absen</button>
            </div>
            
            <h3 style="text-align:left; border-top:1px solid #eee; padding-top:15px">Laporan Terkini:</h3>
            <ul id="report-list" style="padding:0"></ul>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const akunAktif = localStorage.getItem('akun_aktif');
            const roleAdmin = sessionStorage.getItem('role');
            const daftar = JSON.parse(localStorage.getItem('daftar_akun')) || [];

            if (roleAdmin === 'admin') {
                document.getElementById('admin-section').classList.remove('hidden');
                if(window.loadReports) window.loadReports();
            } else if (akunAktif) {
                document.getElementById('peserta-section').classList.remove('hidden');
                document.getElementById('logout-sidebar-btn').classList.remove('hidden'); // Munculkan logout di sidebar
                document.getElementById('display-nama').innerText = JSON.parse(akunAktif).nama;
            } else {
                if (daftar.length === 0) {
                    document.getElementById('modal-tambah').classList.remove('hidden');
                } else if (daftar.length === 1) {
                    localStorage.setItem('akun_aktif', JSON.stringify(daftar[0]));
                    location.reload();
                } else {
                    document.getElementById('pilih-akun-section').classList.remove('hidden');
                    const cont = document.getElementById('list-akun-pilihan');
                    daftar.forEach(a => {
                        cont.innerHTML += `
                        <div class="account-box">
                            <span onclick="pilihAkun(${a.id})" style="flex:1; cursor:pointer; font-weight:bold; text-align:left">${a.nama}</span>
                            <button onclick="hapusAkun(${a.id})" style="width:35px; height:35px; margin:0; padding:0; background:#fc8181; border-radius:8px">âœ•</button>
                        </div>`;
                    });
                }
            }
        });
    </script>
</body>
</html>
